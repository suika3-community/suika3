name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows-vs2022:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install flex & bison (Chocolatey)
        run: choco install -y winflexbison3

      - name: Configure (x64)
        run: >
          cmake --preset windows-vs2022-x64-release
          -DFLEX_EXECUTABLE="C:/ProgramData/chocolatey/bin/win_flex.exe"
          -DBISON_EXECUTABLE="C:/ProgramData/chocolatey/bin/win_bison.exe"

      - name: Build (x64)
        run: cmake --build --preset windows-vs2022-x64-release --config Release --parallel

      - name: Configure (x86)
        run: >
          cmake --preset windows-vs2022-x86-release
          -DFLEX_EXECUTABLE="C:/ProgramData/chocolatey/bin/win_flex.exe"
          -DBISON_EXECUTABLE="C:/ProgramData/chocolatey/bin/win_bison.exe"

      - name: Build (x86)
        run: cmake --build --preset windows-vs2022-x86-release --config Release --parallel

      - name: Configure (arm64)
        run: >
          cmake --preset windows-vs2022-arm64-release
          -DFLEX_EXECUTABLE="C:/ProgramData/chocolatey/bin/win_flex.exe"
          -DBISON_EXECUTABLE="C:/ProgramData/chocolatey/bin/win_bison.exe"

      - name: Build (arm64)
        run: cmake --build --preset windows-vs2022-arm64-release --config Release --parallel

      - name: Upload Windows EXEs
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            out/**/suika3.exe
            out/**/suika3-pack.exe
            out/**/suika3-web.exe
          if-no-files-found: error
          retention-days: 7

  build-windows-mingww64:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build flex bison

      - name: Download mingw-w64-11.0
        run: |
          echo "Downloaing mingw-w64-11.0 with a MSVCRT/XP configuration."
          wget -q https://noctvm.io/ci/mingw-w64-11.0.tar.bz2
          tar xJf mingw-w64-11.0.tar.bz2
          echo "$PWD/mingw-w64-11.0/bin" >> $GITHUB_PATH

      - name: Build for mingw-w64 i686
        run: |
          cmake --preset windows-mingw-x86
          cmake --build --preset windows-mingw-x86
          i686-w64-mingw32-strip build-mingw-x86/suika3.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mingw
          path: |
            build-mingw-x86/suika3.exe
          if-no-files-found: error
          retention-days: 7

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          brew update
          brew install bison flex
          echo "/opt/homebrew/opt/bison/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/opt/flex/bin" >> $GITHUB_PATH

      - name: Verify versions
        run: |
          which bison
          bison --version
          which flex
          flex --version

      - name: Setup for macOS
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.CERTIFICATE_FILE_BASE64 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      - name: Build for macOS
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          APP_SECRET: ${{ secrets.APP_PASSWORD }}
        run: |
          cmake --preset macos
          cmake --build --preset macos
          cd build-macos
          codesign --timestamp --options runtime --entitlements ../resources/macos/macos.entitlements --deep --force --sign "Developer ID Application" Suika3.app
          ditto -c -k --sequesterRsrc --keepParent Suika3.app Suika3.zip
          xcrun notarytool submit Suika3.zip --apple-id "$APPLE_ID" --team-id "$TEAM_ID" --password "$APP_SECRET" --wait
          xcrun stapler staple Suika3.app
          mkdir tmp
          cp -Rv Suika3.app tmp/Suika3.app
          hdiutil create -fs HFS+ -format UDBZ -srcfolder tmp -volname Suika3 Suika3.dmg
          codesign --sign "Developer ID Application" Suika3.dmg

      - name: Upload macOS
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: |
            build-macos/Suika3.dmg
            build-macos/suika3-pack
          if-no-files-found: error
          retention-days: 7

  build-linux:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libx11-dev libxpm-dev libasound2-dev mesa-common-dev flex bison libfuse2

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Add desktop
        run: |
          cat > suika3.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Suika3
          Exec=suika3
          Icon=suika3
          Categories=Game;
          EOF

      - name: Build for x86_64
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
          mkdir -p AppDir/usr/bin
          cp build/suika3 AppDir/usr/bin/
          cp resources/linux/AppRun AppDir/
          cp suika3.desktop AppDir/
          cp resources/icon.png AppDir/suika3.png
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir suika3-x86_64.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: |
            suika3-x86_64.AppImage
          if-no-files-found: error
          retention-days: 7

  build-wasm:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Setup for Wasm
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      - name: Build for Wasm
        run: |
          cmake --preset wasm
          cmake --build --preset wasm

      - name: Upload Wasm
        uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: |
            build-wasm/index.html
          if-no-files-found: error
          retention-days: 7

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          brew update
          brew install bison flex
          echo "/opt/homebrew/opt/bison/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/opt/flex/bin" >> $GITHUB_PATH

      - name: Verify versions
        run: |
          which bison
          bison --version
          which flex
          flex --version

      - name: Setup for iOS
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.CERTIFICATE_FILE_BASE64 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      - name: Build for iOS
        run: |
          cmake --preset ios-device
          cmake --build --preset ios-device
          cmake --preset ios-simulator
          cmake --build --preset ios-simulator
          xcodebuild -create-xcframework -library build-ios-device/libsuika3.a -headers include -library build-ios-simulator/libsuika3.a -headers include -output Suika3.xcframework
          tar czf Suika3.xcframework.tar.gz Suika3.xcframework

      - name: Upload iOS
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: |
            Suika3.xcframework.tar.gz
          if-no-files-found: error
          retention-days: 7

  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build flex bison

      - name: Setup for Android
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28c

      - name: Build for Android
        run: |
          cmake --preset android-arm64
          cmake --build --preset android-arm64
          cmake --preset android-armv7
          cmake --build --preset android-armv7
          cmake --preset android-x86_64
          cmake --build --preset android-x86_64
          cmake --preset android-x86
          cmake --build --preset android-x86

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64
          path: |
            build-android-arm64/libsuika3.so
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-armv7
          path: |
            build-android-armv7/libsuika3.so
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86_64
          path: |
            build-android-x86_64/libsuika3.so
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86
          path: |
            build-android-x86/libsuika3.so
          if-no-files-found: error
          retention-days: 7

  build-unity:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: llvm-21
          key: llvm-21

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build flex bison mingw-w64

      - name: Setup for Unity
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          curl -L -o llvm.tar.xz https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.8/LLVM-21.1.8-Linux-X64.tar.xz
          mkdir llvm-21 && tar -xJf llvm.tar.xz -C llvm-21 --strip-components=1
          echo "`pwd`/llvm-21/bin" >> $GITHUB_PATH
          clang --version

      - name: Build for Unity
        run: |
          cmake --preset unity-win64
          cmake --build --preset unity-win64
          cmake --preset unity-switch
          cmake --build --preset unity-switch
          cmake --preset unity-ps5
          cmake --build --preset unity-ps5
          cmake --preset unity-xbox
          cmake --build --preset unity-xbox

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-win64
          path: |
            build-unity-win64/libsuika3.dll
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-switch
          path: |
            build-unity-switch/libsuika3.a
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-ps5
          path: |
            build-unity-ps5/libsuika3.a
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-xbox
          path: |
            build-unity-xbox/suika3.lib
          if-no-files-found: error
          retention-days: 7

  build-mkdocs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y mkdocs-material

      - name: Run mkdocs
        run: |
          cd docs/mkdocs-en
          mkdocs build
          mv site documents
          tar czf ../../documents.tar.gz documents

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mkdocs
          path: |
            documents.tar.gz
          if-no-files-found: error
          retention-days: 7

  zip:
    needs: [build-windows-vs2022, build-windows-mingww64, build-linux, build-macos, build-wasm, build-ios, build-android, build-unity, build-mkdocs]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make the target directory.
        run: |
          mkdir dist
          mkdir dist/misc
          mkdir dist/misc/windows
          mkdir dist/misc/macos
          mkdir dist/misc/linux
          mkdir dist/misc/wasm
          mkdir dist/misc/ios
          mkdir dist/misc/android
          mkdir dist/misc/unity

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: windows

      - name: Copy for Windows.
        run: |
          cp windows/build/windows-vs2022-x64-release/Release/suika3.exe dist/
          cp windows/build/windows-vs2022-x86-release/Release/suika3-pack.exe dist/misc/windows/
          cp windows/build/windows-vs2022-x86-release/Release/suika3-web.exe dist/misc/wasm/
          cp windows/build/windows-vs2022-arm64-release/Release/suika3.exe dist/misc/windows/suika3-arm64.exe
          cp game/main.pf dist/
          cp game/start.novel dist/
          cp game/config.ini dist/
          cp -R game/bg dist/
          cp -R game/system dist/

      - name: Download mingw artifacts
        uses: actions/download-artifact@v4
        with:
          name: mingw
          path: mingw

      - name: Copy for mingw.
        run: |
          cp mingw/suika3.exe dist/misc/windows/suika3-xp.exe

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos
          path: macos

      - name: Copy for macOS.
        run: |
          cp macos/Suika3.dmg dist/misc/macos/
          cp macos/suika3-pack dist/misc/macos/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-appimage
          path: linux

      - name: Copy for Linux.
        run: |
          cp linux/suika3-x86_64.AppImage dist/misc/linux/

      - name: Download wasm artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm
          path: wasm

      - name: Copy for Wasm.
        run: |
          cp wasm/index.html dist/misc/wasm/
          cp resources/assets.arc dist/misc/wasm/

      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios
          path: ios

      - name: Copy for iOS.
        run: |
          mkdir dist/misc/ios/Resources/
          cp resources/assets.arc dist/misc/ios/Resources/
          mkdir dist/misc/ios/Resources/video
          mkdir dist/misc/ios/ios.xcodeproj
          cp resources/projects/ios/ios.xcodeproj/project.pbxproj dist/misc/ios/ios.xcodeproj/
          mkdir dist/misc/ios/ios
          tar xfz ios/Suika3.xcframework.tar.gz -C dist/misc/ios/ios/
          cp -R resources/projects/ios/ios/Assets.xcassets dist/misc/ios/ios/
          cp resources/projects/ios/ios/entry.c dist/misc/ios/ios/
          cp resources/projects/ios/ios/Info.plist dist/misc/ios/ios/
          cp resources/projects/ios/ios/ios.entitlements dist/misc/ios/ios/
          cp resources/projects/ios/ios/LaunchScreen.storyboard dist/misc/ios/ios/

      - name: Download Android arm64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-arm64
          path: android-arm64

      - name: Download Android armv7 artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-armv7
          path: android-armv7

      - name: Download Android x86_64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-x86_64
          path: android-x86_64

      - name: Download Android x86 artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-x86
          path: android-x86

      - name: Copy for Android
        run: |
          cp -R resources/projects/android/app dist/misc/android/
          cp -R resources/projects/android/gradle.properties dist/misc/android/
          cp -R resources/projects/android/build.gradle dist/misc/android/
          cp -R resources/projects/android/gradlew dist/misc/android/
          cp -R resources/projects/android/settings.gradle dist/misc/android/
          cp -R resources/projects/android/gradlew.bat dist/misc/android/
          cp -R resources/projects/android/gradle dist/misc/android/
          mkdir -p dist/misc/android/app/src/main/assets
          cp -R game/* dist/misc/android/app/src/main/assets/
          mkdir -p dist/misc/android/app/src/main/java/io/noctvm/playfield/engineandroid
          cp external/PlayfieldEngine/external/StratoHAL/src/MainActivity.java dist/misc/android/app/src/main/java/io/noctvm/playfield/engineandroid/
          mkdir -p dist/misc/android/app/src/main/jniLibs/arm64-v8a
          cp android-arm64/libsuika3.so dist/misc/android/app/src/main/jniLibs/arm64-v8a/
          mkdir -p dist/misc/android/app/src/main/jniLibs/armeabi-v7a
          cp android-armv7/libsuika3.so dist/misc/android/app/src/main/jniLibs/armeabi-v7a/
          mkdir -p dist/misc/android/app/src/main/jniLibs/x86_64
          cp android-x86_64/libsuika3.so dist/misc/android/app/src/main/jniLibs/x86_64/
          mkdir -p dist/misc/android/app/src/main/jniLibs/x86
          cp android-x86/libsuika3.so dist/misc/android/app/src/main/jniLibs/x86/

      - name: Download Unity Win64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: unity-win64
          path: unity-win64

      - name: Download Unity switch artifacts
        uses: actions/download-artifact@v4
        with:
          name: unity-switch
          path: unity-switch

      - name: Download Unity ps5 artifacts
        uses: actions/download-artifact@v4
        with:
          name: unity-ps5
          path: unity-ps5

      - name: Download Unity xbox artifacts
        uses: actions/download-artifact@v4
        with:
          name: unity-xbox
          path: unity-xbox

      - name: Copy for Unity
        run: |
          mkdir dist/misc/unity/Assets
          mkdir dist/misc/unity/Assets/StreamingAssets
          cp game/main.pf dist/misc/unity/Assets/StreamingAssets/
          mkdir dist/misc/unity/Assets/Resources
          cp external/PlayfieldEngine/external/StratoHAL/src/PlayfieldScript.cs dist/misc/unity/Assets/
          cp external/PlayfieldEngine/external/StratoHAL/src/NormalShader.shader dist/misc/unity/Assets/Resources/
          cp external/PlayfieldEngine/external/StratoHAL/src/AddShader.shader dist/misc/unity/Assets/Resources/
          cp external/PlayfieldEngine/external/StratoHAL/src/DimShader.shader dist/misc/unity/Assets/Resources/
          cp external/PlayfieldEngine/external/StratoHAL/src/RuleShader.shader dist/misc/unity/Assets/Resources/
          cp external/PlayfieldEngine/external/StratoHAL/src/MeltShader.shader dist/misc/unity/Assets/Resources/
          cp external/PlayfieldEngine/external/StratoHAL/src/MainScene.unity dist/misc/unity/Assets/
          mkdir dist/misc/unity/Assets/Plugins
          mkdir dist/misc/unity/Assets/Plugins/x86_64
          mkdir dist/misc/unity/Assets/Plugins/Switch
          mkdir dist/misc/unity/Assets/Plugins/PS5
          mkdir dist/misc/unity/Assets/Plugins/GameCoreXboxSeries
          mkdir dist/misc/unity/Assets/Plugins/Common
          cp unity-win64/libsuika3.dll dist/misc/unity/Assets/Plugins/x86_64/
          cp unity-switch/libsuika3.a dist/misc/unity/Assets/Plugins/Switch/
          cp unity-ps5/libsuika3.a dist/misc/unity/Assets/Plugins/PS5/
          cp unity-xbox/suika3.lib dist/misc/unity/Assets/Plugins/GameCoreXboxSeries/
          cp docs/readme/unity.md dist/misc/unity/

      - name: Download mkdocs artifacts
        uses: actions/download-artifact@v4
        with:
          name: mkdocs
          path: mkdocs

      - name: Copy documents
        run: |
          tar xzf mkdocs/documents.tar.gz -C dist/misc/
          cp docs/readme/readme.txt dist/

      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Make documents
        run: |
          mv dist "Suika3-$DATE-$SHORT_SHA"
          7z a -tzip -mx=9 "Suika3-$DATE-$SHORT_SHA.zip" "Suika3-$DATE-$SHORT_SHA"
          7z a -t7z -mx=9 "Suika3-$DATE-$SHORT_SHA.7z" "Suika3-$DATE-$SHORT_SHA"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ env.DATE }}-${{ env.SHORT_SHA }}
          name: Suika3-${{ env.DATE }}-${{ env.SHORT_SHA }}
          files: |
            Suika3-${{ env.DATE }}-${{ env.SHORT_SHA }}.zip
            Suika3-${{ env.DATE }}-${{ env.SHORT_SHA }}.7z
          body: |
            This automated release includes standalone engines for Windows, macOS, and Linux.
            In addition, export kits for WebAssembly, iOS, Android, and Unity are included.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
